name: Code Quality

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**/*.py'
      - 'code-quality-tools/**'
  pull_request_target:
    paths:
      - '**/*.py'
      - 'code-quality-tools/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensure history is available for diffs

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dev requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r code-quality-tools/requirements-dev.txt

      - name: Lint (flake8)
        continue-on-error: true
        run: |
          echo "Running flake8 (non-blocking)..."
          flake8 code-quality-tools/src || EXIT=$?
          if [ -n "$EXIT" ]; then echo "flake8 reported issues (exit $EXIT) but continuing"; fi
          flake8 code-quality-tools/src --format=default > flake8.log || true
      - name: Upload flake8 log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake8-log
          path: flake8.log

      - name: Lint (pylint)
        continue-on-error: true
        run: |
          echo "Running pylint (non-blocking)..."
          pylint code-quality-tools/src || EXIT=$?
          if [ -n "$EXIT" ]; then echo "pylint reported issues (exit $EXIT) but continuing"; fi
          pylint code-quality-tools/src > pylint.log || true
      - name: Upload pylint log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pylint-log
          path: pylint.log

      - name: Type check (mypy)
        continue-on-error: true
        run: |
          echo "Running mypy (non-blocking)..."
          mypy code-quality-tools/src || EXIT=$?
          if [ -n "$EXIT" ]; then echo "mypy reported issues (exit $EXIT) but continuing"; fi
          mypy code-quality-tools/src > mypy.log || true
      - name: Upload mypy log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mypy-log
          path: mypy.log

      - name: Security (bandit)
        continue-on-error: true
        run: |
          echo "Running bandit (non-blocking)..."
          bandit -c code-quality-tools/bandit.yaml -r code-quality-tools/src || EXIT=$?
          if [ -n "$EXIT" ]; then echo "bandit reported issues (exit $EXIT) but continuing"; fi
          bandit -c code-quality-tools/bandit.yaml -r code-quality-tools/src -f txt -o bandit.txt || true
      - name: Upload bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit.txt

      - name: Tests + coverage
        continue-on-error: true
        run: |
          echo "Running tests (non-blocking)..."
          pytest -q --maxfail=1 --disable-warnings \
            --cov=code-quality-tools/src --cov-report=term-missing --cov-report=xml:coverage.xml || true

      - name: Upload coverage.xml artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.xml

      - name: Collect diff
        id: diff
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha || '' }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || '' }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.number || '' }}
        run: |
          set -e
          FILES=""
          if [ "$EVENT_NAME" = "pull_request" ] && [ -n "$PR_NUMBER" ]; then
            echo "Collecting changed files via GitHub API for PR #$PR_NUMBER" 
            API_URL="https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/files?per_page=100"
            RESP=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$API_URL" || echo "[]")
            if echo "$RESP" | jq -e type >/dev/null 2>&1; then
              FILES=$(echo "$RESP" | jq -r '.[] | select(.filename|endswith(".py")) | .filename' | sort -u)
            fi
            if [ -z "$FILES" ] && [ -n "$BASE_SHA" ] && [ -n "$HEAD_SHA" ]; then
              echo "API returned no .py changes; falling back to git diff between SHAs"
              git fetch --no-tags --depth=1 origin "$BASE_SHA" || true
              git fetch --no-tags --depth=1 origin "$HEAD_SHA" || true
              FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- '*.py' || true)
            fi
          else
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              FILES=$(git diff --name-only HEAD~1 HEAD -- '*.py' || true)
            else
              FILES=$(git ls-files '*.py' || true)
            fi
          fi
          {
            echo "FILES<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: AI code review (OpenAI GPT-4o)
        if: steps.diff.outputs.FILES != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha || '' }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || '' }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.number || '' }}
          PR_FORK: ${{ github.event.pull_request.head.repo.fork || false }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Preparing AI review..."
          DIFF_CONTENT=""
          if [ "$EVENT_NAME" = "pull_request" ] && [ -n "$PR_NUMBER" ]; then
            API_URL="https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/files?per_page=100"
            RESP=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$API_URL" || echo "[]")
            if echo "$RESP" | jq -e type >/dev/null 2>&1; then
              DIFF_CONTENT=$(echo "$RESP" | jq -r '.[] | select(.filename|endswith(".py")) | "File: \(.filename)\n\(.patch // "")\n"' | sed 's/`/\`/g' | head -c 12000)
            fi
          fi
          if [ -z "$DIFF_CONTENT" ]; then
            echo "Falling back to git diff for diff content"
            if [ "$EVENT_NAME" = "pull_request" ] && [ -n "$BASE_SHA" ] && [ -n "$HEAD_SHA" ]; then
              DIFF_CMD=(git diff "$BASE_SHA" "$HEAD_SHA" -- '*.py')
            else
              if git rev-parse HEAD~1 >/dev/null 2>&1; then
                DIFF_CMD=(git diff HEAD~1 HEAD -- '*.py')
              else
                DIFF_CMD=(git diff -- '*.py')
              fi
            fi
            DIFF_CONTENT="$(${DIFF_CMD[@]} | sed 's/`/\`/g' | head -c 12000)"
          fi
          if [ -z "$DIFF_CONTENT" ]; then
            echo "No diff content captured; skipping AI review." && exit 0
          fi
          PROMPT="You are a code reviewer. Summarize key issues (style, complexity, potential bugs, security) from the unified diff. Provide concise, actionable suggestions and potential test additions. If security concerns exist call them out." 
          JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT" --arg diff "$DIFF_CONTENT" '{model:"gpt-4o",temperature:0.2,messages:[{role:"system",content:$prompt},{role:"user",content:$diff}]}')
          echo "$JSON_PAYLOAD" > ai_request.json
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" || true)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "$BODY" > ai_response_raw.json
          echo "HTTP status: $HTTP_CODE"
          if [ "$HTTP_CODE" -ge 400 ] || ! echo "$BODY" | jq -e '.choices[0].message.content' >/dev/null 2>&1; then
            echo "AI response invalid or error (status $HTTP_CODE). Falling back." 
            REVIEW="(AI review unavailable - status $HTTP_CODE or malformed response)"
          else
            REVIEW=$(echo "$BODY" | jq -r '.choices[0].message.content')
          fi
          echo "$REVIEW" > ai_review.txt
          COMMENT_BODY=$(jq -n --arg body "### AI Code Review\n$REVIEW" '{body:$body}')
          # Decide whether to post PR comment or open an issue
          CAN_COMMENT="false"
          if [ "$EVENT_NAME" = "pull_request" ] && [ "$PR_FORK" != "true" ]; then
            CAN_COMMENT="true"
          fi

          if [ "$CAN_COMMENT" = "true" ]; then
            CRESP=$(curl -s -w "\n%{http_code}" -X POST -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments -d "$COMMENT_BODY" || true)
            CHTTP=$(echo "$CRESP" | tail -n1)
            if [ "$CHTTP" -ge 400 ]; then
              echo "Comment post returned $CHTTP; will attempt to create an issue instead."
              CAN_COMMENT="false"
            else
              echo "Posted PR comment successfully."
            fi
          fi

          if [ "$CAN_COMMENT" != "true" ]; then
            echo "Creating/Posting issue for AI review."
            ISSUE_TITLE="AI Code Review for PR #${{ github.event.number }}"
            ISSUE_BODY=$(jq -n --arg t "$ISSUE_TITLE" --arg r "$REVIEW" --arg pr "${{ github.event.pull_request.html_url || '' }}" \
              '{title:$t, body:("PR: " + $pr + "\n\n" + "### AI Code Review\n" + $r)}')
            IRESP=$(curl -s -w "\n%{http_code}" -X POST -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/issues -d "$ISSUE_BODY" || true)
            IHTTP=$(echo "$IRESP" | tail -n1)
            if [ "$IHTTP" -ge 400 ]; then
              echo "Issue creation returned $IHTTP; writing to job summary instead."
              {
                echo "### AI Code Review"
                echo ""
                echo "$REVIEW"
              } >> "$GITHUB_STEP_SUMMARY"
            else
              echo "Created AI review issue."
            fi
          fi
      - name: Upload AI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review
          path: |
            ai_request.json
            ai_response_raw.json
            ai_review.txt
