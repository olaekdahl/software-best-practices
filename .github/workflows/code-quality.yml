name: Code Quality

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**/*.py'
      - 'code-quality-tools/**'

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dev requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r code-quality-tools/requirements-dev.txt

      - name: Lint (flake8)
        run: flake8 code-quality-tools/src

      - name: Lint (pylint)
        run: pylint code-quality-tools/src || true # allow demo warnings

      - name: Type check (mypy)
        run: mypy code-quality-tools/src

      - name: Security (bandit)
        run: bandit -c code-quality-tools/bandit.yaml -r code-quality-tools/src || true

      - name: Tests + coverage
        run: |
          pytest -q --maxfail=1 --disable-warnings \
            --cov=code-quality-tools/src --cov-report=term-missing --cov-report=xml:coverage.xml

      - name: Upload coverage.xml artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.xml

      - name: Collect diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          echo "FILES<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' >> $GITHUB_OUTPUT || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI code review (GitHub Models gpt-4o)
        if: steps.diff.outputs.FILES != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Preparing AI review..."
          DIFF_CONTENT="$(git diff origin/${{ github.base_ref }}...HEAD -- '*.py' | sed 's/`/\\`/g' | head -c 12000)"
          PROMPT="You are a code reviewer. Summarize key issues (style, complexity, potential bugs, security) from the unified diff. Provide concise, actionable suggestions and potential test additions."
          JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT" --arg diff "$DIFF_CONTENT" '{model:"gpt-4o",messages:[{role:"system",content:$prompt},{role:"user",content:$diff}]}')
          RESPONSE=$(curl -s -X POST https://api.githubcopilot.com/v1/chat/completions -H "Authorization: Bearer ${GH_TOKEN}" -H "Content-Type: application/json" -H "X-GitHub-Api-Version: 2023-11-08" -d "$JSON_PAYLOAD" || true)
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "(AI review unavailable â€“ GitHub Models may not be enabled)"')
          COMMENT_BODY=$(jq -n --arg body "### AI Code Review\n$REVIEW" '{body:$body}')
          curl -s -X POST -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments -d "$COMMENT_BODY" || true
