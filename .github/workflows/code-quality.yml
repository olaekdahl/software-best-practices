name: Code Quality

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**/*.py'
      - 'code-quality-tools/**'

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensure history is available for diffs

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dev requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r code-quality-tools/requirements-dev.txt

      - name: Lint (flake8)
        continue-on-error: true
        run: |
          echo "Running flake8 (non-blocking)..."
          flake8 code-quality-tools/src || EXIT=$?
          if [ -n "$EXIT" ]; then echo "flake8 reported issues (exit $EXIT) but continuing"; fi
          flake8 code-quality-tools/src --format=default > flake8.log || true
      - name: Upload flake8 log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake8-log
          path: flake8.log

      - name: Lint (pylint)
        continue-on-error: true
        run: |
          echo "Running pylint (non-blocking)..."
          pylint code-quality-tools/src || EXIT=$?
          if [ -n "$EXIT" ]; then echo "pylint reported issues (exit $EXIT) but continuing"; fi
          pylint code-quality-tools/src > pylint.log || true
      - name: Upload pylint log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pylint-log
          path: pylint.log

      - name: Type check (mypy)
        continue-on-error: true
        run: |
          echo "Running mypy (non-blocking)..."
          mypy code-quality-tools/src || EXIT=$?
          if [ -n "$EXIT" ]; then echo "mypy reported issues (exit $EXIT) but continuing"; fi
          mypy code-quality-tools/src > mypy.log || true
      - name: Upload mypy log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mypy-log
          path: mypy.log

      - name: Security (bandit)
        continue-on-error: true
        run: |
          echo "Running bandit (non-blocking)..."
          bandit -c code-quality-tools/bandit.yaml -r code-quality-tools/src || EXIT=$?
          if [ -n "$EXIT" ]; then echo "bandit reported issues (exit $EXIT) but continuing"; fi
          bandit -c code-quality-tools/bandit.yaml -r code-quality-tools/src -f txt -o bandit.txt || true
      - name: Upload bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit.txt

      - name: Tests + coverage
        continue-on-error: true
        run: |
          echo "Running tests (non-blocking)..."
          pytest -q --maxfail=1 --disable-warnings \
            --cov=code-quality-tools/src --cov-report=term-missing --cov-report=xml:coverage.xml || true

      - name: Upload coverage.xml artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.xml

      - name: Collect diff
        id: diff
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha || '' }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || '' }}
        run: |
          set -e
          FILES=""
          if [ "$EVENT_NAME" = "pull_request" ] && [ -n "$BASE_SHA" ] && [ -n "$HEAD_SHA" ]; then
            git fetch origin "$BASE_SHA" --depth=1 || true
            git fetch origin "$HEAD_SHA" --depth=1 || true
            FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- '*.py' || true)
          else
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              FILES=$(git diff --name-only HEAD~1 HEAD -- '*.py' || true)
            else
              FILES=$(git ls-files '*.py' || true)
            fi
          fi
          {
            echo "FILES<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: AI code review (GitHub Models gpt-4o)
        if: steps.diff.outputs.FILES != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha || '' }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || '' }}
        run: |
          echo "Preparing AI review..."
          if [ "$EVENT_NAME" = "pull_request" ] && [ -n "$BASE_SHA" ] && [ -n "$HEAD_SHA" ]; then
            DIFF_CMD=(git diff "$BASE_SHA" "$HEAD_SHA" -- '*.py')
          else
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              DIFF_CMD=(git diff HEAD~1 HEAD -- '*.py')
            else
              DIFF_CMD=(git diff -- '*.py')
            fi
          fi
          DIFF_CONTENT="$(${DIFF_CMD[@]} | sed 's/`/\`/g' | head -c 12000)"
          PROMPT="You are a code reviewer. Summarize key issues (style, complexity, potential bugs, security) from the unified diff. Provide concise, actionable suggestions and potential test additions."
          JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT" --arg diff "$DIFF_CONTENT" '{model:"gpt-4o",messages:[{role:"system",content:$prompt},{role:"user",content:$diff}]}')
          RESPONSE=$(curl -s -X POST https://api.githubcopilot.com/v1/chat/completions -H "Authorization: Bearer ${GH_TOKEN}" -H "Content-Type: application/json" -H "X-GitHub-Api-Version: 2023-11-08" -d "$JSON_PAYLOAD" || true)
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "(AI review unavailable â€“ GitHub Models may not be enabled)"')
          COMMENT_BODY=$(jq -n --arg body "### AI Code Review\n$REVIEW" '{body:$body}')
          curl -s -X POST -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments -d "$COMMENT_BODY" || true
