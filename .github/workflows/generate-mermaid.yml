name: Generate Mermaid Diagrams

on:
  workflow_dispatch:
  push:
    paths:
      - "app.py"
      - "scripts/gen_mermaid.py"
      - ".github/workflows/generate-mermaid.yml"

permissions:
  models: read

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate Mermaid diagrams (AST-based)
        env:
          SOURCE_FILE: app.py
          OUTPUT_DIR: diagrams/generated
        run: |
          python scripts/gen_mermaid.py

      - name: (Optional) Generate Mermaid via GitHub Copilot CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh extension install github/gh-copilot || true

          # Ask Copilot CLI to create a concise Mermaid diagram for app.py
          PROMPT='Create a concise Mermaid flowchart summarizing the main components and relationships in app.py. Return only one mermaid fenced code block starting with ```mermaid.'
          TMP_OUT=$(mktemp)
          gh copilot -p "$PROMPT" > "$TMP_OUT" || true

          # Extract the first mermaid fenced block if present; otherwise write a placeholder
          mkdir -p diagrams/generated
          if [ -s "$TMP_OUT" ] && grep -q '```mermaid' "$TMP_OUT"; then
            awk 'BEGIN{p=0} (!p && $0 ~ /^```mermaid\s*$/){p=1; print; next} (p && $0 ~ /^```\s*$/){print; exit} p{print}' "$TMP_OUT" > diagrams/generated/app_ai_flowchart.md
          else
            printf "# AI Mermaid flowchart\n\n_No Copilot output (missing access or empty response)._\n" > diagrams/generated/app_ai_flowchart.md
          fi

      - name: Create Pull Request with updates
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore: update Mermaid diagrams"
          commit-message: "chore: auto-generate Mermaid diagrams"
          branch: bot/update-mermaid-diagrams
          delete-branch: true
          add-paths: |
            diagrams/generated/**
